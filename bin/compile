#!/bin/bash


indent() {
  sed -u 's/^/       /'
}

echo "-----> Preparing for creation of Third Party License File"


if grep -q third_party_license_file_generator $1/requirements.txt; then
  echo "Found third_party_license_file_generator in requirements.txt." | indent
else
  echo "ERROR: third_party_license_file_generator not found in requirements.txt. Skipping." | indent
  exit 0
fi

cd $1

echo "Setting Environment Variables" | indent

# Export all Config Variables into Environment Variables
env_dir=$3
blacklist_regex=${3:-'^(PATH|GIT_DIR|CPATH|CPPATH|LD_PRELOAD|LIBRARY_PATH)$'}
if [ -d "$env_dir" ]; then
  for e in $(ls $env_dir); do
    echo "$e" | grep -qvE "$blacklist_regex" &&
    export "$e=$(cat $env_dir/$e)"
    :
  done
fi

echo "Using DJANGO_SETTINGS_MODULE: $DJANGO_SETTINGS_MODULE" | indent

APP_NAME=$(expr match "$DJANGO_SETTINGS_MODULE" '\(\w\+\)\.\w\+')

echo "Setting App Name: $APP_NAME" | indent

echo "-----> Creating Third Party License File"

python -m third_party_license_file_generator -r requirements.txt -p /app/.heroku/python/bin/python -g -c -o $1/$APP_NAME/static/THIRDPARTYLICENSES.txt | indent

echo "-----> Adding additional Licenses"

cat $1/$APP_NAME/static/ADDITIONALLICENSES.txt >> $1/$APP_NAME/static/THIRDPARTYLICENSES.txt | indent

echo "-----> Recollecting static files"

python manage.py collectstatic --noinput --settings=$DJANGO_SETTINGS_MODULE | indent
